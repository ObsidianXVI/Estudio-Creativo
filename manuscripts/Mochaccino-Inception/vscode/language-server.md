# Langauge Server
<elab about language servers>

## Project Setup
Create `vscode` directory in root directory.
``` sh
cd ./vscode
```

### Installing Node and NPM
```sh
# If curl isn't already installed
sudo apt-get install curl

# Replace the number "16" in "setup_16" with whichever version of node you want to install
curl -sL https://deb.nodesource.com/setup_16.x | sudo -E bash -

# Finally, install node and npm
sudo apt-get install nodejs

# Confirm the installation
node -v && npm -v
```

### Understanding the Project Structure
not gonna clone the `lsp-sample` folder because it's easier to start from scratch (also that way I don't end up merely paraphrasing the VSCode docs).

Instead, we create a `language-server` folder.
Then we `npm init` to get a `package.json` like the following:
```json
{
  "name": "mochaccino-lsp",
  "version": "0.0.1",
  "description": "Language server for the Mochaccino language",
  "main": "./client/out/extension",
  "scripts": {
    "test": "echo \"No test command specified\" && exit 0"
  },
  "keywords": [
    "Mochaccino",
    "lsp"
  ],
  "author": "ObsidianXVI",
  "license": "GPL-3.0"
}
```
Remember, this is in our main directory, so we can add properties that configure the extension as a whole.
```json
  ...
  "activationEvents": [
    "onLanguage:mochaccino"
  ]
}
```
Next we `cd` into the client folder and — you know the drill — run `npm init` to get that juicy boilerplate code:
```json
{
  "name": "mochaccino-lsp-client",
  "version": "0.0.1",
  "description": "The client side of the Language Server extension for Mochaccino",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "ObsidianXVI",
  "license": "GPL-3.0"
}
```
Then, we need to add the dependencies to that allow the client to connect to VSCode:
```json
  ...
  "engines": {
      "vscode": "^1.52.0"
  },
  "dependencies": {
    "vscode": "^1.1.37",
    "vscode-languageclient": "^7.0.0"
  }
}
```

Ok, enough fooling around. Let's get down to business.

Create a `src` folder in the same directory, so that we can write our extension in TypeScript. An `out` folder generated in the same directory will contain the NodeJS code generated by TypeScript for our extension. This is the code that will eventually get executed, not our `extension.ts`, which we shall start working on now:
```ts
import * as path from 'path';
import { workspace, ExtensionContext } from 'vscode';

import {
  LanguageClient,
  LanguageClientOptions,
  ServerOptions,
  TransportKind
} from 'vscode-languageclient/node';

let client: LanguageClient;

export function activate(context: ExtensionContext) {
  // The server is implemented in node
  let serverModule = context.asAbsolutePath(path.join('server', 'out', 'server.js'));
  // The debug options for the server
  // --inspect=6009: runs the server in Node's Inspector mode so VS Code can attach to the server for debugging
  let debugOptions = { execArgv: ['--nolazy', '--inspect=6009'] };

  // If the extension is launched in debug mode then the debug server options are used
  // Otherwise the run options are used
  let serverOptions: ServerOptions = {
    run: { module: serverModule, transport: TransportKind.ipc },
    debug: {
      module: serverModule,
      transport: TransportKind.ipc,
      options: debugOptions
    }
  };

  // Options to control the language client
  let clientOptions: LanguageClientOptions = {
    // Register the server for plain text documents
    documentSelector: [{ scheme: 'file', language: 'plaintext' }],
    synchronize: {
      // Notify the server about file changes to '.clientrc files contained in the workspace
      fileEvents: workspace.createFileSystemWatcher('**/.clientrc')
    }
  };

  // Create the language client and start the client.
  client = new LanguageClient(
    'languageServerExample',
    'Language Server Example',
    serverOptions,
    clientOptions
  );

  // Start the client. This will also launch the server
  client.start();
}

export function deactivate(): Thenable<void> | undefined {
  if (!client) {
    return undefined;
  }
  return client.stop();
}
```
See all those red underlines? Yeah, you probably forgot to run `npm i`. There will still be a few more red underlines, though (because that's just how programming tends to be). The first one is if you're working with TypeScript for the first time. There's a command to install NodeJS types (yep, you read that right):
```sh
npm i -D @types/node
```